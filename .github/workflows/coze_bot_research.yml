name: Coze Bot Research - AIè§£è¯»ç‰ˆ

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8:00 UTC+8 (UTC 0:00)
    - cron: '0 0 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      topic:
        description: 'ç ”ç©¶ä¸»é¢˜'
        required: true
        default: 'AI Agent'
      arxiv_count:
        description: 'arXiv è®ºæ–‡æ•°é‡'
        required: true
        default: '10'

jobs:
  coze-research:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Search arXiv papers
      id: search
      env:
        TOPIC: ${{ github.event.inputs.topic || 'AI Agent' }}
        ARXIV_COUNT: ${{ github.event.inputs.arxiv_count || '10' }}
      run: |
        python .github/scripts/search_arxiv.py
        echo "ğŸ“‚ æœç´¢åçš„æ–‡ä»¶:"
        ls -la *.json *.md 2>/dev/null || echo "æš‚æ—  md/json æ–‡ä»¶"
    
    - name: Send to Coze Bot for analysis
      id: coze
      continue-on-error: true
      env:
        COZE_PAT: ${{ secrets.COZE_PAT }}
        COZE_BOT_ID: ${{ secrets.COZE_BOT_ID }}
        TOPIC: ${{ github.event.inputs.topic || 'AI Agent' }}
      run: |
        python .github/scripts/call_coze_bot.py
        echo "ğŸ“‚ æ‰£å­è§£è¯»åçš„æ–‡ä»¶:"
        ls -la *.json *.md 2>/dev/null || echo "æš‚æ—  md/json æ–‡ä»¶"
    
    - name: Fallback to Kimi API if Coze failed
      id: kimi
      if: steps.coze.outcome != 'success'
      env:
        KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        TOPIC: ${{ github.event.inputs.topic || 'AI Agent' }}
      run: |
        echo "âš ï¸ æ‰£å­ Bot å¤±è´¥ï¼Œä½¿ç”¨ Kimi API è¿›è¡Œè§£è¯»..."
        python .github/scripts/analyze_with_kimi.py
        echo "ğŸ“‚ Kimi è§£è¯»åçš„æ–‡ä»¶:"
        ls -la *.json *.md 2>/dev/null || echo "æš‚æ—  md/json æ–‡ä»¶"
    
    - name: Check files before creating document
      run: |
        echo "ğŸ“‚ åˆ›å»ºæ–‡æ¡£å‰çš„æ–‡ä»¶:"
        ls -la *.json *.md 2>/dev/null || echo "æš‚æ—  md/json æ–‡ä»¶"
        echo ""
        echo "ğŸ“„ latest_analysis.md å†…å®¹é¢„è§ˆ:"
        head -50 latest_analysis.md 2>/dev/null || echo "æ–‡ä»¶ä¸å­˜åœ¨"
    
    - name: Create Feishu document
      # åªè¦æœç´¢æˆåŠŸå°±åˆ›å»ºæ–‡æ¡£ï¼Œä¸ç®¡è§£è¯»æ˜¯å¦æˆåŠŸ
      if: steps.search.outcome == 'success'
      env:
        FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_USER_OPEN_ID: ${{ secrets.FEISHU_USER_OPEN_ID }}
        TOPIC: ${{ github.event.inputs.topic || 'AI Agent' }}
        PAPER_COUNT: ${{ github.event.inputs.arxiv_count || '10' }}
      run: |
        python .github/scripts/create_feishu_doc.py
    
    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coze-research-results
        path: |
          *.json
          *.md
